# 依赖锁定说明

## 📦 当前稳定依赖版本

**锁定日期**: 2025-10-21  
**构建状态**: ✅ iOS 构建成功  
**运行环境**: macOS 24.6.0 / iOS 实机测试通过

---

## 🔒 核心依赖版本

### package.json 关键配置

```json
{
  "name": "exchange-rate-calculator",
  "version": "1.0.0",
  "dependencies": {
    "@dcloudio/uni-app": "3.0.0-4020920240930001",
    "vue": "^3.4.21",
    "big.js": "^6.2.1",
    "pinia": "^2.1.7",
    "pinia-plugin-persistedstate": "^3.2.1"
  },
  "devDependencies": {
    "@dcloudio/types": "^3.4.8",
    "@dcloudio/uni-automator": "3.0.0-4020920240930001",
    "@dcloudio/uni-cli-shared": "3.0.0-4020920240930001",
    "@dcloudio/uni-stacktracey": "3.0.0-4020920240930001",
    "@dcloudio/vite-plugin-uni": "3.0.0-4020920240930001"
  }
}
```

---

## ⚠️ 依赖版本约束说明

### 严格锁定版本
以下依赖必须使用**精确版本**，不可升级：

1. **@dcloudio/uni-app: 3.0.0-4020920240930001**
   - 原因：uni-app 框架核心，版本升级可能导致构建失败
   - 风险：高

2. **@dcloudio/vite-plugin-uni: 3.0.0-4020920240930001**
   - 原因：与 uni-app 版本强绑定
   - 风险：高

### 允许小版本升级
以下依赖使用 `^` 符号，允许小版本升级：

1. **vue: ^3.4.21**
   - 允许范围：3.4.x
   - 不允许：3.5.x 或 4.x.x
   - 原因：Vue 3.4 系列稳定

2. **big.js: ^6.2.1**
   - 允许范围：6.2.x
   - 用途：精确的金额计算
   - 重要性：核心功能依赖

3. **pinia: ^2.1.7**
   - 允许范围：2.1.x
   - 用途：状态管理
   - 兼容性：与 Vue 3.4 兼容

---

## 🚫 禁止的操作

### 1. 禁止执行 npm update
```bash
# ❌ 危险操作
npm update

# ❌ 危险操作
npm update vue

# ❌ 危险操作
npm install @dcloudio/uni-app@latest
```

### 2. 禁止删除 package-lock.json
```bash
# ❌ 除非明确需要重新生成依赖树
rm package-lock.json
```

### 3. 禁止修改 uni-app 相关版本
```bash
# ❌ 会导致构建失败
npm install @dcloudio/uni-app@3.0.0-alpha-xxx
```

---

## ✅ 安全的依赖操作

### 1. 安装依赖（推荐）
```bash
# ✅ 使用 npm ci 确保精确版本
npm ci

# ✅ 或者常规安装
npm install
```

### 2. 添加新依赖
```bash
# ✅ 添加开发依赖
npm install --save-dev <package-name>

# ✅ 添加生产依赖
npm install --save <package-name>
```

### 3. 检查依赖状态
```bash
# ✅ 查看过时的依赖
npm outdated

# ✅ 检查依赖安全性
npm audit

# ✅ 查看依赖树
npm list --depth=0
```

---

## 🔧 依赖问题排查

### 问题1: 构建失败提示版本不匹配

**症状**:
```
Error: Module version mismatch
```

**解决**:
```bash
# 1. 删除 node_modules
rm -rf node_modules

# 2. 删除 package-lock.json
rm package-lock.json

# 3. 清理 npm 缓存
npm cache clean --force

# 4. 重新安装
npm install

# 5. 如果还有问题，使用 npm ci
npm ci
```

### 问题2: big.js 计算错误

**症状**: 金额计算不准确

**检查**:
```bash
# 查看 big.js 版本
npm list big.js

# 应该显示: big.js@6.2.1 或 6.2.x
```

**修复**:
```bash
# 如果版本不对，重新安装
npm install big.js@^6.2.1
```

### 问题3: pinia 状态丢失

**症状**: 应用状态不持久化

**检查**:
```bash
# 确认 pinia-plugin-persistedstate 已安装
npm list pinia-plugin-persistedstate
```

**修复**:
```bash
# 重新安装
npm install pinia@^2.1.7 pinia-plugin-persistedstate@^3.2.1
```

### 问题4: uni-app 构建失败

**症状**: 
```
[plugin:vite:uni-app] xxx
```

**解决**:
```bash
# 1. 确保所有 uni-app 相关包版本一致
npm list | grep @dcloudio

# 2. 应该全部显示: 3.0.0-4020920240930001

# 3. 如果版本不一致，重新安装
rm -rf node_modules package-lock.json
npm install
```

---

## 📋 依赖检查清单

### 安装后验证
```bash
# 1. 检查关键依赖版本
npm list big.js vue pinia @dcloudio/uni-app

# 2. 验证依赖完整性
npm ls

# 3. 检查是否有未解决的依赖
npm audit

# 4. 测试构建
npm run dev:app-plus
```

### 预期输出
```
├── @dcloudio/uni-app@3.0.0-4020920240930001
├── vue@3.4.21
├── big.js@6.2.1
├── pinia@2.1.7
└── pinia-plugin-persistedstate@3.2.1
```

---

## 🔄 回滚时的依赖处理

### 场景1: 回滚到此备份点

```bash
# 1. 回滚代码
git reset --hard bc66ab7

# 2. 确保依赖匹配
npm ci

# 3. 验证依赖
npm list --depth=0
```

### 场景2: 从未来版本回滚

```bash
# 1. 回滚代码
git checkout bc66ab7

# 2. 强制使用此版本的依赖
npm ci

# 3. 如果 package-lock.json 有冲突
git checkout bc66ab7 -- package-lock.json
npm ci

# 4. 清理构建缓存
rm -rf unpackage/dist
```

---

## 📊 依赖关系图

```
汇率速算 App
│
├── 核心框架
│   ├── @dcloudio/uni-app (uni-app 核心)
│   ├── vue (UI 框架)
│   └── @dcloudio/vite-plugin-uni (构建工具)
│
├── 状态管理
│   ├── pinia (状态管理)
│   └── pinia-plugin-persistedstate (持久化)
│
├── 业务逻辑
│   └── big.js (精确计算)
│
└── 开发工具
    ├── @dcloudio/types (类型定义)
    └── @dcloudio/uni-automator (自动化测试)
```

---

## 🎯 依赖更新策略

### 何时可以更新

1. **安全补丁**: 如果 npm audit 报告高危漏洞
   ```bash
   npm audit fix
   ```

2. **bug 修复**: Vue 或 pinia 的小版本 bug 修复
   ```bash
   # 只更新小版本
   npm update vue
   npm update pinia
   ```

3. **测试充分**: 在开发分支充分测试后
   ```bash
   # 创建测试分支
   git checkout -b test-dependency-update
   npm update <package>
   # 测试通过后再合并
   ```

### 何时不应更新

1. ❌ uni-app 核心包（除非官方明确支持）
2. ❌ 项目稳定运行时（非必要不动）
3. ❌ 临近发布版本时
4. ❌ 没有测试环境时

---

## 💾 备份建议

### 依赖备份
```bash
# 备份当前依赖状态
cp package.json package.json.backup
cp package-lock.json package-lock.json.backup

# 或者提交到 git
git add package.json package-lock.json
git commit -m "backup: 锁定依赖版本"
```

### 恢复依赖
```bash
# 从备份恢复
cp package.json.backup package.json
cp package-lock.json.backup package-lock.json
npm ci
```

---

## 📱 特定平台注意事项

### iOS 构建
- 依赖版本对 iOS 构建影响较大
- uni-app 版本必须稳定
- 建议在本地测试后再云打包

### Android 构建
- 对依赖版本要求相对宽松
- 但仍建议保持版本一致

### H5 构建
- 对前端依赖敏感
- Vue 版本需要稳定

---

## 🔍 依赖审计

### 定期检查（每月一次）
```bash
# 1. 检查过时的包
npm outdated

# 2. 检查安全漏洞
npm audit

# 3. 检查依赖树
npm ls

# 4. 生成依赖报告
npm list --depth=0 > dependencies-report.txt
```

---

## 📞 紧急联系

如果遇到依赖相关的严重问题：

1. 查看 `package.json` 和 `package-lock.json`
2. 参考本文档的版本约束
3. 尝试 `npm ci` 重新安装
4. 如果问题持续，回滚到备份点 bc66ab7

---

**重要提示**: 
- 此配置已在生产环境验证
- 任何依赖变更都需要充分测试
- 保持 package-lock.json 在版本控制中

**最后更新**: 2025-10-21  
**维护人**: 开发团队

