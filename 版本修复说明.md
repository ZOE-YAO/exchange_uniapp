# 🔧 依赖版本冲突修复

## 🎯 根本问题

### 原始配置（错误）❌
```json
{
  "dependencies": {
    "@dcloudio/uni-app": "3.0.0-alpha-4010520231122001",  // 2023年11月 alpha
    "vue": "^3.4.21",                                       // 2024年2月
    "vue-router": "^4.3.0"                                 // 2024年
  },
  "devDependencies": {
    "@dcloudio/vite-plugin-uni": "3.0.0-alpha-4010520231122001",  // 2023年11月
    "vite": "^5.2.8",                                              // 2024年3月
    "@vitejs/plugin-vue": "^5.0.4"                                // 2024年
  }
}
```

**问题分析**：
- ❌ UniApp 使用 **2023年11月** 的 alpha 测试版
- ❌ Vite 使用 **2024年3月** 的新版本（5.2.8）
- ❌ Vue 使用 **2024年2月** 的新版本（3.4.21）
- ❌ 版本相差 **4-5个月**，API 和构建配置完全不兼容

### 根本原因
```
旧版 UniApp (2023-11)
    ↓ 使用旧版构建配置
    ↓ 期望 Vite 4.x
    ↓ 期望 Vue 3.3.x
    ✗ 与新版 Vite 5.2 冲突
    ✗ 构建配置不兼容
    ✗ 导致 "iife format" 错误
```

---

## ✅ 修复方案

### 新配置（正确）
```json
{
  "dependencies": {
    "pinia": "^2.1.7",      // 状态管理
    "big.js": "^6.2.1",     // 精确计算
    "dayjs": "^1.11.10"     // 日期处理
    // ✅ 移除所有 UniApp 相关依赖
    // ✅ 由 HBuilderX 提供
  },
  "devDependencies": {
    "@dcloudio/types": "^3.4.8",                          // 类型定义
    "@dcloudio/vite-plugin-uni": "^3.0.0-4020420240930001",  // 2024年9月
    "vite": "5.2.8",                                      // 固定版本
    "sass": "^1.77.6"                                     // 样式预处理
  }
}
```

**关键改动**：
1. ✅ **移除** `@dcloudio/uni-app` - 由 HBuilderX 提供
2. ✅ **移除** `vue` 和 `vue-router` - 由 HBuilderX 提供
3. ✅ **升级** `@dcloudio/vite-plugin-uni` 到 2024年9月版本
4. ✅ **固定** `vite` 版本为 `5.2.8`（不使用 ^）
5. ✅ **移除** 其他冲突的 UniApp 依赖
6. ✅ **添加** `sass` 支持样式预处理

---

## 🔍 为什么这样修复？

### UniApp 项目的特殊性

**HBuilderX 提供的依赖**：
```
HBuilderX 内置：
  ├── @dcloudio/uni-app
  ├── @dcloudio/uni-cli-shared
  ├── @dcloudio/uni-stacktracey
  ├── vue
  ├── vue-router
  └── 其他 UniApp 核心依赖
```

**项目只需要**：
```
package.json：
  ├── 业务依赖（pinia, big.js, dayjs）
  ├── Vite 插件（@dcloudio/vite-plugin-uni）
  ├── 构建工具（vite）
  └── 类型定义（@dcloudio/types）
```

### 版本策略

| 依赖 | 策略 | 原因 |
|------|------|------|
| **@dcloudio/vite-plugin-uni** | 最新稳定版 | 核心构建插件 |
| **vite** | 固定版本 | 避免自动升级导致冲突 |
| **业务依赖** | 使用 ^ | 可以小版本更新 |
| **UniApp 核心** | 不安装 | HBuilderX 提供 |

---

## 📋 执行步骤

### 1. 清理旧依赖
```bash
cd /Users/tongyao/Desktop/开发/app/汇率速算

# 删除旧的依赖和锁文件
rm -rf node_modules
rm package-lock.json
```

### 2. 安装新依赖
```bash
# 如果有网络权限问题，使用 --legacy-peer-deps
npm install --legacy-peer-deps
```

### 3. 清理构建缓存
```bash
rm -rf unpackage
```

### 4. 在 HBuilderX 中重新运行
```
1. 关闭 HBuilderX（完全退出）
2. 重新打开项目
3. 运行 → 运行到手机或模拟器 → iOS模拟器
```

---

## 🎯 预期结果

### 成功标志
- ✅ `npm install` 无冲突警告
- ✅ 编译无 `iife` 错误
- ✅ 模拟器成功启动
- ✅ App 功能正常

### 版本兼容性
```
@dcloudio/vite-plugin-uni@3.0.0-4020420240930001
    ↓ 兼容
vite@5.2.8
    ↓ 兼容
HBuilderX 内置的 Vue 3.x
    ↓ 完美运行
✓ 构建成功
```

---

## 📝 版本选择说明

### @dcloudio/vite-plugin-uni 版本号解读
```
3.0.0-4020420240930001
 │ │ │  │    │
 │ │ │  │    └─ 构建序号：001
 │ │ │  └────── 日期：2024年09月30日
 │ │ └─────────  CLI 版本：402042
 │ └─────────── 次版本：0
 └───────────── 主版本：3
```

这是 **2024年9月30日** 的稳定版本，与：
- ✅ Vite 5.2.x 完全兼容
- ✅ Vue 3.4.x 完全兼容
- ✅ HBuilderX 3.x 完全兼容

---

## 🚨 注意事项

### 不要做
- ❌ 不要手动安装 `@dcloudio/uni-app`
- ❌ 不要手动安装 `vue` 或 `vue-router`
- ❌ 不要随意升级 vite 版本
- ❌ 不要使用 alpha/beta 测试版

### 应该做
- ✅ 让 HBuilderX 管理 UniApp 核心依赖
- ✅ 项目只管理业务依赖
- ✅ 固定 vite 版本避免自动升级
- ✅ 使用稳定版本而非测试版

---

## 🔄 如果将来需要升级

### 查看最新版本
```bash
npm view @dcloudio/vite-plugin-uni versions --json
```

### 升级策略
```bash
# 1. 查看 HBuilderX 版本
# 2. 查看对应的 vite-plugin-uni 版本
# 3. 更新 package.json
# 4. 清理并重新安装
rm -rf node_modules package-lock.json
npm install --legacy-peer-deps
```

---

## 📚 相关资源

- [UniApp 官方文档](https://uniapp.dcloud.net.cn/)
- [Vite 版本兼容性](https://vitejs.dev/)
- [HBuilderX 更新日志](https://www.dcloud.io/hbuilderx.html)

---

## ✅ 总结

**核心原则**：
> 在 UniApp 项目中，HBuilderX 是依赖管理的核心。
> 项目的 package.json 只需要管理业务依赖和构建工具。
> 不要试图覆盖 HBuilderX 的内置依赖。

**版本策略**：
> 使用与 HBuilderX 版本匹配的 vite-plugin-uni。
> 避免使用测试版（alpha/beta）。
> 固定 vite 版本避免意外升级。

---

**修复完成！执行安装命令，然后在 HBuilderX 中重新构建！** 🚀

