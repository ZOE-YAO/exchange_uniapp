# 🔧 简化 Vite 配置说明

## 变更原因

之前添加的自定义构建配置可能干扰了 UniApp 插件的默认行为，导致 iOS 构建失败。

---

## 📋 配置对比

### 原配置（复杂）❌
```javascript
export default defineConfig({
  plugins: [uni()],
  build: {
    target: 'es2015',
    minify: 'terser',
    cssCodeSplit: false,
    rollupOptions: {
      output: {
        manualChunks: undefined,
        inlineDynamicImports: true,  // ← 可能冲突
      }
    },
    chunkSizeWarningLimit: 1500,
    assetsInlineLimit: 4096,
  },
  optimizeDeps: {
    exclude: ['vue-demi']
  },
  server: { /* ... */ }
})
```

**问题**：
- 自定义 `output` 配置与 UniApp 插件冲突
- UniApp 需要使用 `iife` 格式，但我们的配置可能覆盖了它
- 过度配置导致构建流程混乱

---

### 新配置（简化）✅
```javascript
export default defineConfig({
  plugins: [uni()],
  // 移除所有 build 自定义配置
  // 让 UniApp 插件完全控制构建流程
  server: {
    port: 8080,
    host: '0.0.0.0',
    proxy: { /* ... */ }  // 仅保留 H5 开发代理
  }
})
```

**优点**：
- ✅ UniApp 插件自动处理所有平台差异
- ✅ 不会冲突或覆盖必要的配置
- ✅ H5、App、小程序都能正常构建
- ✅ 维护简单，不易出错

---

## 🎯 关键原则

### UniApp 构建的特殊性

UniApp 不是普通的 Vite 项目，它有特殊的构建需求：

| 平台 | 输出格式 | 代码分割 | 特殊处理 |
|------|---------|---------|---------|
| **H5** | ESM | 支持 | 标准 Web 构建 |
| **App** | IIFE | 不支持 | 需要原生桥接 |
| **小程序** | CommonJS | 部分支持 | 需要适配各平台 |

**`@dcloudio/vite-plugin-uni` 的作用**：
- 自动识别目标平台
- 应用正确的构建配置
- 处理条件编译
- 转换 API 调用

**我们不应该**：
- ❌ 强制指定 `output.format`
- ❌ 禁用代码分割（插件会自动处理）
- ❌ 覆盖 `rollupOptions`

**我们应该**：
- ✅ 信任 UniApp 插件的默认配置
- ✅ 只配置项目特定的需求（如代理）
- ✅ 使用官方工具（HBuilderX）进行复杂构建

---

## 📝 完整的新配置

```javascript
import { defineConfig } from 'vite'
import uni from '@dcloudio/vite-plugin-uni'

export default defineConfig({
  plugins: [
    uni(),
  ],
  server: {
    port: 8080,
    host: '0.0.0.0',
    // 仅 H5 开发需要代理（避免 CORS）
    proxy: {
      '/api/v6': {
        target: 'https://open.er-api.com',
        changeOrigin: true,
        secure: false,
        rewrite: (path) => path.replace(/^\/api/, '')
      },
      '/api/v4': {
        target: 'https://api.exchangerate-api.com',
        changeOrigin: true,
        secure: false,
        rewrite: (path) => path.replace(/^\/api/, '')
      }
    }
  }
})
```

---

## 🧪 测试步骤

### 1. H5 开发测试
```bash
npm run dev:h5
```
访问 `http://localhost:8080`，应该能正常运行。

### 2. iOS 模拟器测试（HBuilderX）

**步骤**：
1. 打开 HBuilderX
2. 文件 → 打开目录 → 选择项目
3. 运行 → 运行到手机或模拟器 → iOS 模拟器
4. 等待编译和启动

**预期结果**：
- ✅ 不再出现 `iife` 格式错误
- ✅ 模拟器正常启动
- ✅ App 功能正常

### 3. iOS 云打包测试

**步骤**：
1. 在 HBuilderX 中
2. 运行 → 发行 → 原生App-云打包
3. 选择 iOS
4. 等待云端构建

**预期结果**：
- ✅ 构建成功
- ✅ 生成 ipa 文件
- ✅ 可安装到真机

---

## 🔍 如果仍然失败

### 检查清单

1. **确认 HBuilderX 版本**
   - 推荐使用最新稳定版
   - Alpha 版本可能有兼容性问题

2. **检查 manifest.json**
   - 确保 `appid` 已配置
   - 检查 `app-plus` 配置是否正确

3. **清理缓存**
   ```bash
   # 清理 node_modules
   rm -rf node_modules
   npm install
   
   # 清理构建产物
   rm -rf unpackage
   ```

4. **使用云打包而不是本地打包**
   - 云打包环境更稳定
   - 不受本地配置影响

---

## 📚 参考资料

- [UniApp Vite 配置](https://uniapp.dcloud.net.cn/collocation/vite-config.html)
- [UniApp App 平台配置](https://uniapp.dcloud.net.cn/collocation/manifest-app.html)
- [Vite 配置参考](https://vitejs.dev/config/)

---

## 🎉 总结

**核心思想**：
> 少即是多。让专业的工具做专业的事。

**最佳实践**：
- ✅ H5 开发：命令行 + 简单配置
- ✅ App 构建：HBuilderX + 默认配置
- ✅ 特殊需求：咨询官方文档

**记住**：
> UniApp 插件已经为我们处理了 99% 的复杂性，
> 我们只需要提供 1% 的项目特定配置即可。

---

**更新完成！现在可以在 HBuilderX 中测试了！** 🚀

